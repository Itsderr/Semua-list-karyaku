<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>LaluLintasKu ‚Äî Statistik & Laporan</title>
    <style>
        :root{
            --blue-dark: #004494;
            --blue: #0056b3;
            --page-bg: #f0f2f5;
            --panel-bg: #fff;
            --text-color: #333;
            --link-color: #0056b3;
            --border-color: #e0e0e0;
        }
        body{
            margin:0; font-family: Inter, system-ui, Arial, sans-serif;
            background-color: var(--page-bg);
            color: var(--text-color);
            line-height: 1.6;
            background-image: url('background.png');
            background-size: cover;
            background-attachment: fixed;
            background-position: center center;
        }
        .header{
            background: var(--panel-bg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-sizing: border-box;
        }
        .header h1{
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            color: var(--blue);
            cursor: pointer;
        }
        .navbar a{
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            margin-left: 25px;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .navbar a:hover, .navbar a.active{
            color: var(--blue-dark);
            transform: translateY(-2px);
        }
        .main{
            padding: 80px 20px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .card{
            background: var(--panel-bg);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            margin: 20px auto;
            text-align: center;
        }
        .card h2, .card h3{
            margin-top:0;
            margin-bottom: 20px;
            color: var(--blue-dark);
            font-weight: 600;
        }
        select, textarea, input[type="text"], input[type="file"], input[type="password"]{
            width: 100%;
            max-width: 500px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 16px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        textarea{ min-height: 120px; resize: vertical; }
        .btn{
            background: var(--blue-dark);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease;
        }
        .btn:hover{ background: var(--blue); }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
        .stats-card{
            max-width: 900px;
            margin: 20px auto;
            padding: 30px;
            border-radius: 16px;
            background: var(--panel-bg);
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
        }
        table{
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            overflow-x: auto;
            display: block;
        }
        th,td{
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            text-align: center;
            font-size: 14px;
        }
        th{ background: #f7faf7; color: #222; }
        .status-lancar, .status-ramai, .status-padat, .status-macet, .status-gangguan, .status-kecelakaan{
            font-weight: 700;
        }
        .status-lancar{ color: #2b8a3e; }
        .status-ramai{ color: #f08c00; }
        .status-padat{ color: #c67a00; }
        .status-macet{ color: #d92727; }
        .status-gangguan{ color: #f0a500; }
        .status-kecelakaan{ color: #ff0000; }
        .muted{ color: #666; font-size: 13px; margin-top: 8px; }
        .small{ font-size: 13px; color: #444; }
        .filter-item {
            margin-bottom: 15px;
            text-align: left;
        }
        .filter-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .status-lancar {
          color: #2b8a3e;
        }
        .status-macet {
          color: #d92727;
        }
        .suggestion-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: var(--blue-dark);
            color: white;
            border: none;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            font-size: 26px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1500;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background 0.2s ease;
        }
        .suggestion-btn:hover {
            transform: scale(1.1);
            background: var(--blue);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
            width: 90%;
            max-width: 450px;
            text-align: center;
        }
        .modal-content h3 {
            margin-top: 0;
        }
        .modal-close-btn {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close-btn:hover, .modal-close-btn:focus {
            color: #000;
            text-decoration: none;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
        }
        .admin-report-container {
            text-align: left;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }
        .admin-report-container h4 {
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .admin-report-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .admin-report-item:last-child {
            border-bottom: none;
        }
        .admin-report-photo {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
        }
        .action-buttons button {
            margin-right: 8px;
        }
        /* Media Queries for Mobile */
        @media (max-width: 600px) {
            .header{
                flex-direction: column;
                padding: 10px;
            }
            .header h1{
                margin-bottom: 10px;
            }
            .navbar a{
                margin: 0 10px;
            }
            .main{
                padding-top: 100px;
            }
        }
    </style>
</head>
<body>

<header class="header">
  <h1>LaluLintasKu</h1>
  <nav class="navbar" id="navbar">
    <a href="#" data-target="statistikSection" class="active">Statistik</a>
    <a href="#" data-target="laporanSection">Laporan</a>
    <a href="#" data-target="kameraSection">Sistem Kamera</a>
  </nav>
</header>

<main class="main" id="mainContent">

<section id="statistikSection" class="stats-card">
  <h3>üìä Statistik Laporan (‚â§ 1 jam)</h3>
  <div style="margin-bottom:12px;">
    <div class="filter-item">
      <label for="filterProv">Provinsi:</label>
      <select id="filterProv">
        <option value="">-- Pilih Provinsi --</option>
        <option value="Jawa Timur">Jawa Timur</option>
        <option value="Jawa Barat">Jawa Barat</option>
        <option value="DKI Jakarta">DKI Jakarta</option>
      </select>
    </div>
    
    <div class="filter-item">
      <label for="filterKota">Kota:</label>
      <select id="filterKota">
        <option value="">-- Pilih Kota --</option>
      </select>
    </div>
    
    <div class="filter-item">
      <label for="filterDaerah">Daerah:</label>
      <select id="filterDaerah">
        <option value="">-- Pilih Daerah --</option>
      </select>
    </div>
  </div>

  <div id="chartContainer">
    <div id="chartBox"><canvas id="chart"></canvas></div>
    <div id="chartInfo">Belum ada laporan.</div>
  </div>
</section>

<section id="laporanSection" class="card" style="display:none;">
  <h2>Laporan Lalu Lintas</h2>
  <label for="provinsi">Pilih Provinsi:</label>
  <select id="provinsi"><option value="">-- Pilih Provinsi --</option><option value="Jawa Timur">Jawa Timur</option><option value="Jawa Barat">Jawa Barat</option><option value="DKI Jakarta">DKI Jakarta</option></select>

  <div id="kotaWrap" style="display:none;"><label for="kota">Pilih Kota/Kabupaten:</label><select id="kota"><option value="">-- Pilih Kota --</option></select></div>
  <div id="daerahWrap" style="display:none;"><label for="daerah">Pilih Daerah/Kecamatan:</label><select id="daerah"><option value="">-- Pilih Daerah --</option></select></div>
  <div id="jalanWrap" style="display:none;"><label for="jalan">Pilih Nama Jalan:</label><select id="jalan"><option value="">-- Pilih Nama Jalan --</option></select></div>
  <div id="statusWrap" style="display:none;"><label for="status">Status Kondisi:</label><select id="status"><option value="">-- Pilih Kondisi --</option><option value="Macet">Macet</option><option value="Gangguan Lalu Lintas">Gangguan Lalu Lintas</option><option value="Kecelakaan">Kecelakaan</option></select></div>
  <div id="descWrap" style="display:none;"><label for="deskripsi">Deskripsi (opsional):</label><textarea id="deskripsi" placeholder="Contoh: Lampu merah tidak berfungsi / antrean 500m"></textarea></div>
  <div id="fotoWrap" style="display:none;"><label for="foto">Tambahkan Foto (opsional):</label><input type="file" id="foto" accept="image/*"><img id="fotoPreview" src=""></div>
  <div id="lokasiWrap" style="display:none;"><button class="btn" id="getLocationBtn">üìç Dapatkan Lokasi</button><div id="lokasiInfo" class="small"></div></div>
  <div id="submitWrap" style="display:none;"><button class="btn" id="submitBtn">Kirim Laporan</button><div class="muted">Laporan akan masuk ke ringkasan dan statistik. Batas maksimal 1 laporan per 20 menit per device.</div></div>
  <div id="summary" style="margin-top:18px;"></div>
</section>

<section id="kameraSection" class="card" style="display:none;">
  <h3>üì∏ Statistik sistem kamera</h3>
  <div id="kameraStatusContainer">
    <p>Status:</p>
    <div id="kameraStatus" style="font-size: 1.5rem; font-weight: bold;">Memuat data...</div>
    <p class="muted">Jumlah Kendaraan: <span id="vehicleCount">Memuat...</span></p>
  </div>
</section>

<section id="loginSection" class="card" style="display:none;">
  <h3>Login Admin</h3>
  <form id="loginForm">
    <label for="username">Username:</label>
    <input type="text" id="username" placeholder="Masukkan username">
    <label for="password">Password:</label>
    <input type="password" id="password" placeholder="Masukkan password">
    <button type="submit" class="btn">Login</button>
  </form>
</section>

<section id="adminSection" class="stats-card" style="display:none;">
  <h3 style="display:flex; justify-content: space-between; align-items: center;">
      <span>Laporan Admin</span>
      <button class="btn" id="logoutBtn">Logout</button>
  </h3>
  
  <div class="admin-report-container">
      <h4>Laporan Menunggu Persetujuan</h4>
      <div id="pendingReportsContainer">
          <p>Memuat laporan...</p>
      </div>
  </div>

  <div class="admin-report-container" style="margin-top:20px;">
      <h4>Laporan Sudah Disetujui</h4>
      <div id="confirmedReportsContainer">
          <p>Memuat laporan...</p>
      </div>
  </div>
</section>

</main>

<footer class="footer">
    <button class="btn" id="footerLoginBtn">Login Admin</button>
</footer>

<button class="suggestion-btn" id="suggestionBtn">
  üìù
</button>

<div id="saranModal" class="modal">
  <div class="modal-content">
    <span class="modal-close-btn" id="saranCloseBtn">&times;</span>
    <h3>üìù Kotak Saran</h3>
    <p class="muted">Kritik dan saran Anda akan berguna bagi kami ke depannya.</p>
    <div style="margin-top:20px;">
        <textarea id="saranTextarea" placeholder="Masukkan saran atau masukan Anda di sini..." style="width:92%; max-width:560px;"></textarea>
    </div>
    <button class="btn" id="submitSaranBtn">Kirim Saran</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAVHQKQ3iAGWPepnd_DuoGQmpxG40i8uMs",
      authDomain: "laporan-lalu-lintas.firebaseapp.com",
      databaseURL: "https://laporan-lalu-lintas-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "laporan-lalu-lintas",
      storageBucket: "laporan-lalu-lintas.appspot.com",
      messagingSenderId: "706382913725",
      appId: "1:706382913725:web:1069a4f53bea6b66a357d4"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const navLinks = document.querySelectorAll('.navbar a');
    const sections = document.querySelectorAll('main section');
    const defaultSectionId = 'statistikSection';

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = e.target.getAttribute('data-target');
            
            sections.forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(targetId).style.display = 'block';

            navLinks.forEach(navLink => {
                navLink.classList.remove('active');
            });
            e.target.classList.add('active');
        });
    });

    document.getElementById('footerLoginBtn').addEventListener('click', () => {
        sections.forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById('loginSection').style.display = 'block';
        navLinks.forEach(navLink => {
            navLink.classList.remove('active');
        });
    });

    document.getElementById(defaultSectionId).style.display = 'block';

    const provEl = document.getElementById('provinsi');
    const kotaEl = document.getElementById('kota');
    const daerahEl = document.getElementById('daerah');
    const jalanEl = document.getElementById('jalan');
    const kotaWrap = document.getElementById('kotaWrap');
    const daerahWrap = document.getElementById('daerahWrap');
    const jalanWrap = document.getElementById('jalanWrap');
    const statusWrap = document.getElementById('statusWrap');
    const descEl = document.getElementById('deskripsi');
    const submitWrap = document.getElementById('submitWrap');
    const fotoWrap = document.getElementById('fotoWrap');
    const lokasiWrap = document.getElementById('lokasiWrap');
    const summaryDiv = document.getElementById('summary');
    const lokasiInfo = document.getElementById('lokasiInfo');
    const fotoEl = document.getElementById('foto');
    const fotoPreview = document.getElementById('fotoPreview');

    const wilayah = {
      "Jawa Timur": {
        "Surabaya": {
          "Genteng": ["Jalan Tunjungan", "Jalan Gubernur Suryo", "Jalan Embong Malang"],
          "Wonokromo": ["Jalan Joyoboyo", "Jalan Ngagel", "Jalan Raya Darmo"]
        },
        "Sidoarjo": {
          "Krian": ["Jalan Raya Krian", "Jalan Ahmad Yani", "Jalan Basuki Rahmat"],
          "Waru": ["Jalan Raya Waru", "Jalan Letjend Suprapto", "Jalan Bypass Juanda"]
        },
        "Banyuwangi": {
          "Kecamatan Glagah": ["Jalan Raya Glagah", "Jalan Raya Licin", "Jalan Raya Rogojampi"],
          "Kecamatan Rogojampi": ["Jalan Raya Rogojampi", "Jalan S Parman", "Jalan MH Thamrin"]
        }
      },
      "Jawa Barat": {
        "Bandung": {
          "Coblong": ["Jalan Dago", "Jalan Ciumbuleuit", "Jalan Dipati Ukur"],
          "Sukajadi": ["Jalan Sukajadi", "Jalan Setiabudi", "Jalan Dr. Setiabudhi"]
        },
        "Bekasi": {
          "Bekasi Timur": ["Jalan Pahlawan", "Jalan Cut Mutia", "Jalan Ir. H. Juanda"],
          "Bekasi Selatan": ["Jalan Ahmad Yani", "Jalan KH Noer Ali", "Jalan Jend Sudirman"]
        }
      },
      "DKI Jakarta": {
        "Jakarta Pusat": {
          "Gambir": ["Jalan Medan Merdeka", "Jalan Majapahit", "Jalan Veteran"],
          "Menteng": ["Jalan Menteng Raya", "Jalan Teuku Umar", "Jalan Cikini Raya"]
        },
        "Jakarta Timur": {
          "Duren Sawit": ["Jalan Pahlawan Revolusi", "Jalan Swadaya", "Jalan Dermaga"],
          "Cakung": ["Jalan Raya Cakung", "Jalan Raya Bekasi", "Jalan I Gusti Ngurah Rai"]
        }
      }
    };

    provEl.addEventListener('change', ()=>{
      const prov = provEl.value;
      kotaEl.innerHTML='<option value="">-- Pilih Kota --</option>';
      daerahEl.innerHTML='<option value="">-- Pilih Daerah --</option>';
      jalanEl.innerHTML='<option value="">-- Pilih Nama Jalan --</option>';
      kotaWrap.style.display=daerahWrap.style.display=jalanWrap.style.display=statusWrap.style.display='none';
      descEl.parentNode.style.display='none';
      submitWrap.style.display=fotoWrap.style.display=lokasiWrap.style.display='none';
      summaryDiv.innerHTML='';
      if(prov && wilayah[prov]){
        Object.keys(wilayah[prov]).forEach(k=>{
          const o=document.createElement('option'); o.value=k; o.textContent=k; kotaEl.appendChild(o);
        });
        kotaWrap.style.display='block';
      }
    });

    kotaEl.addEventListener('change', ()=>{
      const prov=provEl.value, kota=kotaEl.value;
      daerahEl.innerHTML='<option value="">-- Pilih Daerah --</option>';
      jalanEl.innerHTML='<option value="">-- Pilih Nama Jalan --</option>';
      daerahWrap.style.display=jalanWrap.style.display=statusWrap.style.display='none';
      descEl.parentNode.style.display='none';
      submitWrap.style.display=fotoWrap.style.display=lokasiWrap.style.display='none';
      summaryDiv.innerHTML='';
      if(prov && kota && wilayah[prov][kota]){
        Object.keys(wilayah[prov][kota]).forEach(d=>{
          const o=document.createElement('option'); o.value=d; o.textContent=d; daerahEl.appendChild(o);
        });
        daerahWrap.style.display='block';
      }
    });

    daerahEl.addEventListener('change', ()=>{
      const prov=provEl.value, kota=kotaEl.value, daerah=daerahEl.value;
      jalanEl.innerHTML='<option value="">-- Pilih Nama Jalan --</option>';
      if(daerah && wilayah[prov][kota][daerah]){
        wilayah[prov][kota][daerah].forEach(j=>{
          const o=document.createElement('option'); o.value=j; o.textContent=j; jalanEl.appendChild(o);
        });
        jalanWrap.style.display='block';
        statusWrap.style.display='block';
        descEl.parentNode.style.display='block';
        submitWrap.style.display=fotoWrap.style.display=lokasiWrap.style.display='block';
        updateSummary();
      } else {
        jalanWrap.style.display='none';
        statusWrap.style.display='none';
        descEl.parentNode.style.display='none';
        submitWrap.style.display=fotoWrap.style.display=lokasiWrap.style.display='none';
        summaryDiv.innerHTML='';
      }
    });

    let currentLocation = null;
    document.getElementById('getLocationBtn').addEventListener('click', ()=>{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          currentLocation = {lat: pos.coords.latitude, lng: pos.coords.longitude};
          lokasiInfo.textContent = `Latitude: ${currentLocation.lat.toFixed(5)}, Longitude: ${currentLocation.lng.toFixed(5)}`;
        }, ()=>{ lokasiInfo.textContent='Gagal mendapatkan lokasi'; });
      }else{ lokasiInfo.textContent='Browser tidak mendukung GPS'; }
    });

    fotoEl.addEventListener('change', ()=>{
      if(fotoEl.files[0]){
        const reader = new FileReader();
        reader.onload = e=>{ fotoPreview.src = e.target.result; };
        reader.readAsDataURL(fotoEl.files[0]);
      } else { fotoPreview.src = ''; }
    });

    let lastSent = localStorage.getItem('lastSent') || 0;
    const canSend = ()=> Date.now() - lastSent >= 20*60*1000;

    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    submitBtn.addEventListener('click', async () => {
      if (!provEl.value || !kotaEl.value || !daerahEl.value || !jalanEl.value || !statusEl.value) {
        alert('Mohon lengkapi semua pilihan yang tersedia.');
        return;
      }
      if (!canSend()) {
        alert('‚è± Tunggu 20 menit sebelum mengirim laporan lagi.');
        return;
      }

      const laporan = {
        provinsi: provEl.value,
        kota: kotaEl.value,
        daerah: daerahEl.value,
        jalan: jalanEl.value || '',
        status: statusEl.value,
        deskripsi: descEl.value || '',
        foto: '',
        lokasi: currentLocation || {},
        waktu: Date.now(),
        konfirmasi: 'pending' // Default status is pending
      };

      if (fotoEl.files.length > 0) {
        try {
          const file = fotoEl.files[0];
          const storageRef = sRef(storage, `laporan_foto/${Date.now()}_${file.name}`);
          const uploadTask = uploadBytesResumable(storageRef, file);

          await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Unggah foto sedang berjalan: ' + progress.toFixed(0) + '%');
              },
              (error) => {
                reject(error);
              },
              () => {
                resolve();
              }
            );
          });
          
          laporan.foto = await getDownloadURL(storageRef);
          console.log("Foto berhasil diunggah. URL:", laporan.foto);
        } catch (e) {
          console.error("Kesalahan saat mengunggah foto:", e);
          alert('‚ö†Ô∏è Gagal mengunggah foto. Laporan tetap akan dikirim tanpa foto.');
        }
      }

      try {
        await push(ref(db, 'laporan'), laporan);
        console.log("Laporan berhasil dikirim!");

        lastSent = Date.now();
        localStorage.setItem('lastSent', lastSent);
        statusEl.value = '';
        descEl.value = '';
        fotoEl.value = '';
        fotoPreview.src = '';
        currentLocation = null;
        lokasiInfo.textContent = '';
        alert('‚úÖ Laporan berhasil dikirim! Menunggu konfirmasi admin.');
      } catch (error) {
        console.error("Kesalahan saat mengirim laporan ke Realtime Database:", error);
        alert('‚ùå Gagal mengirim laporan. Coba lagi atau periksa koneksi internet Anda.');
      }
    });

    const saranModal = document.getElementById('saranModal');
    const suggestionBtn = document.getElementById('suggestionBtn');
    const saranCloseBtn = document.getElementById('saranCloseBtn');
    const saranTextarea = document.getElementById('saranTextarea');
    const submitSaranBtn = document.getElementById('submitSaranBtn');

    suggestionBtn.addEventListener('click', () => {
        saranModal.style.display = 'flex';
    });
    saranCloseBtn.addEventListener('click', () => {
        saranModal.style.display = 'none';
    });
    window.addEventListener('click', (event) => {
        if (event.target == saranModal) {
            saranModal.style.display = 'none';
        }
    });

    submitSaranBtn.addEventListener('click', async () => {
        const saran = saranTextarea.value;
        if (!saran) {
            alert('Mohon isi saran Anda sebelum mengirim.');
            return;
        }

        try {
            await push(ref(db, 'saran_pengguna'), {
                saran: saran,
                waktu: Date.now()
            });
            saranTextarea.value = '';
            saranModal.style.display = 'none';
            alert('‚úÖ Saran Anda berhasil dikirim!');
        } catch (error) {
            console.error("Kesalahan saat mengirim saran:", error);
            alert('‚ùå Gagal mengirim saran. Coba lagi atau periksa koneksi internet Anda.');
        }
    });

    const ctx = document.getElementById('chart').getContext('2d');
    let chart = new Chart(ctx, {type:'bar', data:{labels:['Macet','Gangguan Lalu Lintas','Kecelakaan'], datasets:[{label:'Jumlah Laporan',data:[0,0,0],backgroundColor:['#d92727','#f0a500','#ff0000']}]}, options:{responsive:true,plugins:{legend:{display:false}}}});

    const filterProv = document.getElementById('filterProv');
    const filterKota = document.getElementById('filterKota');
    const filterDaerah = document.getElementById('filterDaerah');

    filterProv.addEventListener('change', ()=>{
      filterKota.innerHTML='<option value="">-- Pilih Kota --</option>';
      filterDaerah.innerHTML='<option value="">-- Pilih Daerah --</option>';
      if(filterProv.value && wilayah[filterProv.value]){
        Object.keys(wilayah[filterProv.value]).forEach(k=>{
          const o=document.createElement('option'); o.value=k; o.textContent=k; filterKota.appendChild(o);
        });
      }
      updateChart();
    });
    filterKota.addEventListener('change', ()=>{
      filterDaerah.innerHTML='<option value="">-- Pilih Daerah --</option>';
      if(filterProv.value && filterKota.value && wilayah[filterProv.value][filterKota.value]){
        Object.keys(wilayah[filterProv.value][filterKota.value]).forEach(d=>{
          const o=document.createElement('option'); o.value=d; o.textContent=d; filterDaerah.appendChild(o);
        });
      }
      updateChart();
    });
    filterDaerah.addEventListener('change', updateChart);

    function updateChart(){
      if(!filterProv.value || !filterKota.value || !filterDaerah.value) { document.getElementById('chartInfo').innerText='Pilih Provinsi, Kota, dan Daerah terlebih dahulu'; return; }

      onValue(ref(db,'laporan'), snapshot=>{
        const data = snapshot.val() || {};
        const now = Date.now();
        const laporanArr = Object.values(data).filter(l => (l.konfirmasi === 'confirmed' || !l.konfirmasi) && (now - l.waktu < 3600000) );
        const counts={'Macet':0,'Gangguan Lalu Lintas':0,'Kecelakaan':0};
        laporanArr.forEach(l=>{
          if(l.provinsi!==filterProv.value || l.kota!==filterKota.value || l.daerah!==filterDaerah.value) return;
          if(counts[l.status]!==undefined) counts[l.status]++;
        });
        chart.data.datasets[0].data = [counts['Macet'], counts['Gangguan Lalu Lintas'], counts['Kecelakaan']];
        chart.update();
        const total=Object.values(counts).reduce((a,b)=>a+b,0);
        let mayoritas='Belum ada laporan';
        let alasan='';
        if(total>0){
          const max=Math.max(...Object.values(counts));
          const winners=Object.keys(counts).filter(k=>counts[k]===max && max>0);
          mayoritas=winners.length===1?winners[0]:'Seimbang';
          alasan=`Jumlah laporan terbanyak di kategori "${mayoritas}"`;
        }
        document.getElementById('chartInfo').innerHTML=`
          <b>Total laporan:</b> ${total}<br>
          <b>Macet:</b> ${counts['Macet']}<br>
          <b>Gangguan Lalu Lintas:</b> ${counts['Gangguan Lalu Lintas']}</b><br>
          <b>Kecelakaan:</b> ${counts['Kecelakaan']}</b><br>
          <b>Mayoritas:</b> ${mayoritas}</b><br>
          <b>Alasan:</b> ${alasan}
        `;
      });
    }
    updateChart();

    function updateSummary(){
      const prov=provEl.value, kota=kotaEl.value, daerah=daerahEl.value;
      if(!prov||!kota||!daerah) return;
      onValue(ref(db,'laporan'), snapshot=>{
        const data = snapshot.val() || {};
        const now = Date.now();
        const laporanArr = Object.values(data).filter(l => (l.konfirmasi === 'confirmed' || !l.konfirmasi) && (now - l.waktu < 3600000) );
        const counts={'Macet':0,'Gangguan Lalu Lintas':0,'Kecelakaan':0};
        laporanArr.forEach(l=>{ if(l.provinsi===prov && l.kota===kota && l.daerah===daerah) counts[l.status]++; });
        const total=Object.values(counts).reduce((a,b)=>a+b,0);
        let mayoritas='Belum ada laporan', alasan='';
        if(total>0){
          const max=Math.max(...Object.values(counts));
          const winners=Object.keys(counts).filter(k=>counts[k]===max && max>0);
          mayoritas=winners.length===1?winners[0]:'Seimbang';
          alasan=`Jumlah laporan terbanyak di kategori "${mayoritas}"`;
        }
        summaryDiv.innerHTML=`<div style="margin-top:16px; text-align:center;">
          <div style="display:inline-block; padding:10px 16px; background:#f7f7f7; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.04);">
            <div style="font-size:14px;color:#555">Ringkasan untuk <b>${daerah}, ${kota}</b></div>
            <div style="margin-top:8px; text-align:left;">
              <div>Macet: <b>${counts['Macet']}</b></div>
              <div>Gangguan Lalu Lintas: <b>${counts['Gangguan Lalu Lintas']}</b></div>
              <div>Kecelakaan: <b>${counts['Kecelakaan']}</b></div>
              <div style="margin-top:8px;color:#222">Mayoritas: <b>${mayoritas}</b></div>
              <div style="color:#444">Alasan: ${alasan}</div>
            </div>
          </div>
        </div>`;
      });
    }

    const kameraStatusEl = document.getElementById('kameraStatus');
    const vehicleCountEl = document.getElementById('vehicleCount');
    
    // Gunakan try-catch untuk menangani potential error
    try {
        const kameraRef = ref(db, 'traffic/status');
        onValue(kameraRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                kameraStatusEl.textContent = data.status.toUpperCase();
                vehicleCountEl.textContent = data.vehicle_count;
                kameraStatusEl.classList.remove('status-lancar', 'status-macet');
                if (data.status === 'macet') {
                    kameraStatusEl.classList.add('status-macet');
                } else {
                    kameraStatusEl.classList.add('status-lancar');
                }
            } else {
                kameraStatusEl.textContent = "DATA TIDAK TERSEDIA";
                vehicleCountEl.textContent = "-";
                kameraStatusEl.classList.remove('status-macet');
                kameraStatusEl.classList.add('status-lancar');
            }
        });
    } catch (e) {
        console.error("Kesalahan inisialisasi Firebase:", e);
        kameraStatusEl.textContent = "Gagal memuat data. Periksa konsol.";
        vehicleCountEl.textContent = "Gagal";
    }

    // --- Admin Login & Report Viewer ---
    const loginForm = document.getElementById('loginForm');
    const pendingReportsContainer = document.getElementById('pendingReportsContainer');
    const confirmedReportsContainer = document.getElementById('confirmedReportsContainer');
    const logoutBtn = document.getElementById('logoutBtn');

    const ADMIN_USERNAME = "admin";
    const ADMIN_PASSWORD = "admin123";

    function showAdminSection() {
        sections.forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById('adminSection').style.display = 'block';
        loadReports();
    }

    function loadReports() {
        pendingReportsContainer.innerHTML = '<p>Memuat laporan pending...</p>';
        confirmedReportsContainer.innerHTML = '<p>Memuat laporan yang sudah disetujui...</p>';
        const reportsRef = ref(db, 'laporan');
        onValue(reportsRef, (snapshot) => {
            const reports = snapshot.val() || {};
            const pendingReports = [];
            const confirmedReports = [];

            for (const key in reports) {
                if (reports[key].konfirmasi === 'pending') {
                    pendingReports.push({ id: key, ...reports[key] });
                } else {
                    confirmedReports.push({ id: key, ...reports[key] });
                }
            }
            
            pendingReports.sort((a, b) => b.waktu - a.waktu);
            confirmedReports.sort((a, b) => b.waktu - a.waktu);

            renderReports(pendingReports, pendingReportsContainer, 'pending');
            renderReports(confirmedReports, confirmedReportsContainer, 'confirmed');
        });
    }

    function renderReports(reports, container, type) {
        if (reports.length === 0) {
            container.innerHTML = `<p>Tidak ada laporan ${type === 'pending' ? 'yang menunggu persetujuan' : 'yang sudah disetujui'}.</p>`;
            return;
        }
        
        let reportHtml = '';
        reports.forEach(report => {
            const date = new Date(report.waktu).toLocaleString();
            const photoHtml = report.foto ? `<img src="${report.foto}" alt="Foto Laporan" class="admin-report-photo">` : '';
            const statusClass = `status-${report.status.toLowerCase().replace(/\s/g, '-')}`;

            reportHtml += `
                <div class="admin-report-item">
                    <p><b>Waktu:</b> ${date}</p>
                    <p><b>Lokasi:</b> ${report.jalan}, ${report.daerah}, ${report.kota}, ${report.provinsi}</p>
                    <p><b>Status:</b> <span class="${statusClass}">${report.status.toUpperCase()}</span></p>
                    <p><b>Deskripsi:</b> ${report.deskripsi || '-'}</p>
                    ${photoHtml}
                    <div class="action-buttons" style="margin-top:10px;">
                        ${type === 'pending' ? `<button class="btn btn-success" onclick="approveReport('${report.id}')">Setuju</button>` : ''}
                        <button class="btn btn-danger" onclick="deleteReport('${report.id}')">Hapus</button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = reportHtml;
    }

    window.approveReport = async (reportId) => {
        if (confirm('Yakin ingin menyetujui laporan ini?')) {
            const updates = {};
            updates['/laporan/' + reportId + '/konfirmasi'] = 'confirmed';
            try {
                await update(ref(db), updates);
                alert('Laporan berhasil disetujui!');
            } catch (error) {
                console.error("Kesalahan saat menyetujui laporan:", error);
                alert('Gagal menyetujui laporan.');
            }
        }
    };

    window.deleteReport = async (reportId) => {
        if (confirm('Yakin ingin menghapus laporan ini?')) {
            try {
                await remove(ref(db, 'laporan/' + reportId));
                alert('Laporan berhasil dihapus!');
            } catch (error) {
                console.error("Kesalahan saat menghapus laporan:", error);
                alert('Gagal menghapus laporan.');
            }
        }
    };

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
            showAdminSection();
            document.getElementById('loginSection').style.display = 'none';
        } else {
            alert('Username atau password salah!');
        }
    });

    logoutBtn.addEventListener('click', () => {
        sections.forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(defaultSectionId).style.display = 'block';
        navLinks.forEach(navLink => {
            navLink.classList.remove('active');
        });
        document.querySelector(`[data-target="${defaultSectionId}"]`).classList.add('active');
    });

</script>
</body>
</html>
